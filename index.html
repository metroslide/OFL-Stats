addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request))
})

const DISCORD_WEBHOOK = 'INPUT_HERE'
const GITHUB_TOKEN = 'INPUT_HERE'
const GITHUB_USERNAME = 'INPUT_HERE'
const STATS_WEBSITE = 'INPUT_HERE'

async function handleRequest(request) {
  if (request.method !== 'POST') {
    return new Response('Method not allowed', { status: 405 })
  }

  try {
    const data = await request.json()
    
    const gistData = {
      description: `OFL Stats - ${data.awayName} vs ${data.homeName} - ${new Date().toISOString()}`,
      public: false,
      files: {
        [data.fileName]: {
          content: data.csvData
        },
        'stats.json': {
          content: JSON.stringify({
            awayName: data.awayName,
            homeName: data.homeName,
            awayScore: data.awayScore,
            homeScore: data.homeScore,
            teamStats: data.teamStats,
            quarterlyScores: data.quarterlyScores,
            csvData: data.csvData,
            fileName: data.fileName,
            timestamp: new Date().toISOString()
          })
        }
      }
    }

    const gistResponse = await fetch('https://api.github.com/gists', {
      method: 'POST',
      headers: {
        'Authorization': `token ${GITHUB_TOKEN}`,
        'Content-Type': 'application/json',
        'User-Agent': 'OFL-Stats-Bot'
      },
      body: JSON.stringify(gistData)
    })

    const gist = await gistResponse.json()
    const statsUrl = `${STATS_WEBSITE}?id=${gist.id}`

    const discordPayload = {
      username: 'OFL Stats',
      embeds: data.embeds
    }

    discordPayload.embeds[0].fields.push({
      name: 'ðŸ“Š Full Game Stats',
      value: `[View Complete Stats & Download CSV](${statsUrl})`,
      inline: false
    })

    discordPayload.embeds[0].url = statsUrl

    await fetch(DISCORD_WEBHOOK, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(discordPayload)
    })

    return new Response(JSON.stringify({
      success: true,
      statsUrl: statsUrl,
      gistId: gist.id
    }), {
      status: 200,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*'
      }
    })

  } catch (error) {
    return new Response(JSON.stringify({
      success: false,
      error: error.message
    }), {
      status: 500,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*'
      }
    })
  }
}
